# ScreenBase

`ScreenBase` — базовый класс для "классического" экрана: один экран = одно окно + контейнер виджетов.  
Подходит для форм, диалогов, мастер-экранов и прочих сценариев, где вся логика сосредоточена в одном окне.

---

## Идея

Экран работает по циклу:

1. `ensureWindow()` — создание окна экрана.
2. `build()` — единоразовое создание виджетов и их регистрация в `WidgetContainer`.
3. `layout()` — отрисовка рамок/заголовков/статических надписей.
4. `render()` (внутри `ScreenBase`) — фон → layout → widgets → курсор → `doupdate()`.
5. `handle()` — обработка глобальных клавиш → обработка контейнером → перерисовка.
6. `close()` — освобождение ресурсов виджетов/панели/окна.

---

## Автоматически обеспечиваемое поведение

`ScreenBase`:

- гарантирует существование `Window`, `Panel`, `WidgetContainer`;
- вызывает `build()` ровно один раз (`_built`);
- управляет активностью виджетов (`_ui.setActive(true/false)` на show/hide);
- выполняет последовательность отрисовки:
  - установка курсора по настройкам сессии (`setCursor(context.session.settings.cursor)`);
  - установка фона (`setBackground(theme.WindowBackground)`);
  - пользовательская разметка (`layout`);
  - отрисовка виджетов (`_ui.render`);
  - обновление панелей (`_panel.update`);
  - установка курсора активному виджету (`_ui.applyCursor`);
  - применение изменений (`doupdate()`).

---

## Контракт экрана

### ensureWindow()
Определяет геометрию окна экрана.

Типовые варианты:

- полноэкранный режим: `new Window(H, W, 0, 0)`
- диалог в центре: `new Window(h, w, (H-h)/2, (W-w)/2)`

`H/W` обычно берутся из `getmaxy/getmaxx(context.session.root())`.

---

### layout()
Отрисовывает статические элементы:

- рамка (`border`)
- заголовок
- подсказки
- декоративные элементы

`layout()` предполагается идемпотентным и может вызываться многократно. Создание виджетов в `layout()` не предполагается.

---

### build()
Создаёт виджеты и добавляет их в контейнер.

- порядок `ui.add(widget)` задаёт порядок Tab-переключения;
- связывание виджетов выполняется колбэками (например, checkbox → enable/disable button, menu → setText, textbox → validation).

---

### handleGlobal()
Обрабатывает глобальные клавиши, которые должны иметь приоритет над виджетами:

- `Esc` / `q` → `quit/pop`
- функциональные клавиши (например, F1 help)
- обработка `ERR` (часто трактуется как выход из демо или завершение цикла)

`ScreenBase.handle()` вызывает `handleGlobal()` первым. При возврате действия с `kind != None` дальнейшая обработка ввода не выполняется.

---

## Область применения

`ScreenBase` подходит, когда:

- UI укладывается в одно окно;
- требуется простой стек экранов (`Push/Pop`) и передача результата родителю (`ScreenResult`);
- фокус ограничен виджетами одного окна (Tab переключает виджеты внутри одного контейнера).
